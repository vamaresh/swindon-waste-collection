<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swindon Bin Collections</title>
    <meta name="description" content="Check your waste collection schedule for Swindon Borough Council">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header-icon {
            font-size: 1.2em;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1em;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .success {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .success.active {
            display: block;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .collection-card {
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .collection-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .collection-card.rubbish::before {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .collection-card.recycling::before {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .collection-card.garden::before {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .collection-card.plastics::before {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .collection-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }

        .collection-type {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .collection-date {
            font-size: 1.1em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .collection-days {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .collection-days.today {
            background: #f56565;
            animation: pulse 2s infinite;
        }

        .collection-days.tomorrow {
            background: #ed8936;
        }

        .future-dates {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .future-dates strong {
            color: #4a5568;
            display: block;
            margin-bottom: 8px;
        }

        .future-dates ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .future-dates li {
            padding: 4px 0;
            color: #718096;
        }

        .future-dates li:before {
            content: "üìÖ ";
            margin-right: 5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .hidden {
            display: none;
        }

        select option {
            padding: 10px;
        }

        .info-text {
            text-align: center;
            color: #718096;
            font-size: 0.95em;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .collections-grid {
                grid-template-columns: 1fr;
            }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #48bb78;
            color: white;
        }

        /* Calendar buttons */
        .calendar-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .calendar-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .calendar-btn-google {
            background: #4285f4;
            color: white;
        }

        .calendar-btn-apple {
            background: #000;
            color: white;
        }

        .calendar-btn-outlook {
            background: #0078d4;
            color: white;
        }

        .change-address-btn {
            background: #718096;
            color: white;
            margin-top: 20px;
        }

        .change-address-btn:hover {
            background: #4a5568;
        }

        /* Custom Address List Styles */
        .address-search {
            margin-bottom: 15px;
        }

        .address-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
        }

        .address-search input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .address-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .address-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .address-item:last-child {
            border-bottom: none;
        }

        .address-item:hover {
            background: #f7fafc;
        }

        .address-item.selected {
            background: #667eea;
            color: white;
        }

        .address-item.selected:hover {
            background: #5568d3;
        }

        .address-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .address-item.selected .address-radio {
            border-color: white;
            background: white;
        }

        .address-item.selected .address-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
        }

        .address-text {
            flex: 1;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .no-addresses {
            padding: 20px;
            text-align: center;
            color: #718096;
            font-style: italic;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .address-list {
                max-height: 350px;
            }

            .address-item {
                padding: 12px;
            }

            .address-text {
                font-size: 0.9em;
            }
        }

        .cached-info {
            background: #e6fffa;
            border: 2px solid #81e6d9;
            color: #234e52;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .cached-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt.active {
            display: block;
        }

        .install-prompt button {
            background: white;
            color: #667eea;
            margin-top: 10px;
        }

        .assistant-info {
            background: #fef5e7;
            border: 2px solid #f9e79f;
            color: #7d6608;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .assistant-info h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .assistant-info p {
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .assistant-info ul {
            margin-left: 20px;
            font-size: 0.9em;
        }

        .reminder-note {
            margin: 12px 0 8px 0;
            padding: 8px 12px;
            background: #fef5e7;
            border-left: 3px solid #f39c12;
            color: #7d6608;
            font-size: 0.85em;
            border-radius: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .install-app-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .enable-notifications-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .notifications-enabled {
            background: #48bb78;
            cursor: default;
        }

        .notifications-enabled:hover {
            transform: none;
            box-shadow: none;
        }

        .add-calendar-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-calendar-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .calendar-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .calendar-modal.active {
            display: flex;
        }

        .calendar-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .calendar-modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .calendar-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .calendar-option-btn {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            color: #2d3748;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1em;
            font-weight: 600;
        }

        .calendar-option-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateX(5px);
        }

        .calendar-option-btn .icon {
            font-size: 1.5em;
        }

        .modal-close {
            margin-top: 20px;
            padding: 10px;
            background: #e2e8f0;
            color: #2d3748;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        .modal-close:hover {
            background: #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span class="header-icon">üóëÔ∏è</span>
                Swindon Bin Dates
            </h1>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <!-- Error Message -->
        <div class="error" id="errorMessage"></div>

        <!-- Success Message -->
        <div class="success" id="successMessage"></div>

        <!-- Install Prompt -->
        <div class="install-prompt" id="installPrompt">
            <p>üì± <strong>Install this app</strong> for quick access to your bin collection dates!</p>
            <button onclick="installApp()" class="btn">Install App</button>
            <button onclick="dismissInstall()" class="btn" style="background: transparent; color: white; border: 1px solid white;">Not Now</button>
        </div>

        <!-- Cached Info -->
        <div class="cached-info hidden" id="cachedInfo">
            <strong>üìç Saved Address</strong>
            <p id="cachedAddress"></p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">Your collection schedule is displayed below</p>
        </div>

        <!-- Step 1: Postcode Form -->
        <div class="card" id="postcodeCard">
            <div class="form-group">
                <label for="postcode">Enter Your Postcode</label>
                <input 
                    type="text" 
                    id="postcode" 
                    placeholder="e.g., SN1 1XX" 
                    autocomplete="postal-code"
                    maxlength="8"
                >
            </div>
            <button onclick="lookupPostcode()" id="postcodeBtn">
                Find Addresses
            </button>
        </div>

        <!-- Step 2: Address Selector -->
        <div class="card hidden" id="addressCard">
            <div class="form-group">
                <label for="addressSearch">Select Your Address</label>
                <div class="address-search">
                    <input 
                        type="text" 
                        id="addressSearch" 
                        placeholder="üîç Search addresses..." 
                        autocomplete="off"
                    />
                </div>
                <div class="address-list" id="addressList">
                    <!-- Addresses will be populated here -->
                </div>
            </div>
            <button onclick="handleAddressSelect()" id="addressBtn" disabled>
                Continue
            </button>
        </div>

        <!-- Loading Spinner -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <!-- Step 3: Collections Display -->
        <div class="card hidden" id="collectionsCard">
            <h2 style="margin-bottom: 20px; color: #2d3748; text-align: center;">
                üìÖ Your Collection Schedule
            </h2>
            <div class="collections-grid" id="collectionsGrid"></div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button onclick="installPWA()" class="action-btn install-app-btn" id="installAppBtn" style="display: none;">
                    üì± Install App
                </button>
                <button onclick="enableNotifications()" class="action-btn enable-notifications-btn" id="notificationBtn">
                    üîî Enable Reminders
                </button>
            </div>
            
            <!-- Smart Assistant Info -->
            <div class="assistant-info">
                <h3>ü§ñ Smart Assistant Integration</h3>
                <p><strong>To get voice reminders on Alexa or Google Assistant:</strong></p>
                <ul>
                    <li><strong>Google Assistant:</strong> Add reminders to Google Calendar (click buttons above), then Google Assistant will notify you automatically</li>
                    <li><strong>Alexa:</strong> Link your Google or Outlook calendar to Alexa in the Alexa app (Settings ‚Üí Calendar ‚Üí Link calendar)</li>
                    <li><strong>Siri:</strong> Add to Apple Calendar, Siri will automatically remind you</li>
                </ul>
                <p style="margin-top: 10px;">üí° All calendar reminders are set for <strong>1 day before</strong> collection at 5:00 PM</p>
            </div>

            <button onclick="clearCache()" class="btn change-address-btn">
                Change Address
            </button>
        </div>

        <p class="info-text">
            Data provided by Swindon Borough Council
        </p>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api';
        const CACHE_KEY = 'swindon_waste_data';
        const CACHE_EXPIRY_DAYS = 1; // Cache for 1 day
        
        let addresses = [];
        let selectedUPRN = null;
        let cachedCollections = null;
        let deferredPrompt = null;

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install prompt if not previously dismissed
            if (!localStorage.getItem('installDismissed')) {
                document.getElementById('installPrompt').classList.add('active');
            }
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('active');
                });
            }
        }

        // PWA Install button (persistent)
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                        document.getElementById('installAppBtn').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('To install this app:\\n\\niOS: Tap Share ‚Üí Add to Home Screen\\nAndroid: Tap Menu ‚Üí Install App\\nDesktop: Look for install icon in address bar');
            }
        }

        // Show install button when prompt is available
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installAppBtn').style.display = 'inline-flex';
            if (!localStorage.getItem('installDismissed')) {
                document.getElementById('installPrompt').classList.add('active');
            }
        });

        // Browser Notifications
        async function enableNotifications() {
            const btn = document.getElementById('notificationBtn');
            
            if (!('Notification' in window)) {
                alert('This browser does not support notifications.');
                return;
            }

            if (Notification.permission === 'granted') {
                alert('Notifications are already enabled! ‚úÖ\\n\\nYou will receive reminders at 5 PM the day before each collection.');
                return;
            }

            if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in your browser settings:\\n\\n1. Click the lock icon in the address bar\\n2. Find Notifications\\n3. Change to Allow');
                return;
            }

            // Request permission
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                btn.textContent = '‚úÖ Reminders Enabled';
                btn.classList.add('notifications-enabled');
                
                // Save to cache and schedule notifications
                localStorage.setItem('notifications_enabled', 'true');
                scheduleNotifications();
                
                // Show test notification
                new Notification('üóëÔ∏è Swindon Waste Collections', {
                    body: 'Reminders enabled! You will be notified at 5 PM the day before each collection.',
                    icon: '/icons/icon-192x192.png'
                });
            } else {
                alert('Notification permission denied. You can enable it later in browser settings.');
            }
        }

        // Schedule notifications for all collection dates
        function scheduleNotifications() {
            if (!cachedCollections || cachedCollections.length === 0) return;
            
            const now = new Date();
            
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                
                dates.forEach(dateStr => {
                    const collectionDate = new Date(dateStr);
                    const reminderDate = new Date(collectionDate);
                    reminderDate.setDate(reminderDate.getDate() - 1);
                    reminderDate.setHours(17, 0, 0, 0); // 5 PM day before
                    
                    const timeUntilReminder = reminderDate.getTime() - now.getTime();
                    
                    // Only schedule future notifications (within 24 hours for browser compatibility)
                    if (timeUntilReminder > 0 && timeUntilReminder < 24 * 60 * 60 * 1000) {
                        setTimeout(() => {
                            if (Notification.permission === 'granted') {
                                new Notification(`üóëÔ∏è ${collection.type}`, {
                                    body: `Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`,
                                    icon: collection.bin_image || '/icons/icon-192x192.png',
                                    badge: '/icons/icon-192x192.png',
                                    tag: `collection-${dateStr}`,
                                    requireInteraction: true
                                });
                            }
                        }, timeUntilReminder);
                    }
                });
            });
        }

        // Check notification status on load
        function checkNotificationStatus() {
            if (Notification.permission === 'granted') {
                const btn = document.getElementById('notificationBtn');
                btn.textContent = '‚úÖ Reminders Enabled';
                btn.classList.add('notifications-enabled');
                scheduleNotifications();
            }
        }

        function dismissInstall() {
            localStorage.setItem('installDismissed', 'true');
            document.getElementById('installPrompt').classList.remove('active');
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Check if we're in development or production
        const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        console.log('Environment:', isDev ? 'Development' : 'Production');
        console.log('API Base:', API_BASE);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkCache();
            checkNotificationStatus();
        });

        // Check for cached data
        function checkCache() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                const now = new Date().getTime();
                const cacheAge = now - data.timestamp;
                const maxAge = CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;

                if (cacheAge < maxAge) {
                    // Cache is still valid
                    selectedUPRN = data.uprn;
                    cachedCollections = data.collections;
                    
                    // Show cached info
                    document.getElementById('cachedAddress').textContent = data.address;
                    document.getElementById('cachedInfo').classList.remove('hidden');
                    
                    // Auto-load collections
                    displayCollections(cachedCollections);
                    hideElement('postcodeCard');
                    hideElement('addressCard');
                    updateSteps(3);
                } else {
                    // Cache expired
                    clearCache();
                }
            }
        }

        // Save to cache
        function saveToCache(uprn, address, collections) {
            const data = {
                uprn: uprn,
                address: address,
                collections: collections,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        }

        // Clear cache
        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            document.getElementById('cachedInfo').classList.add('hidden');
            reset();
        }

        // Update step indicator
        function updateSteps(currentStep) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
        }

        // Show/hide elements
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('active');
            setTimeout(() => successEl.classList.remove('active'), 3000);
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // Lookup postcode
        async function lookupPostcode() {
            const postcode = document.getElementById('postcode').value.trim().toUpperCase();
            
            if (!postcode) {
                showError('Please enter a postcode');
                return;
            }
            
            // Basic postcode validation
            const postcodeRegex = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i;
            if (!postcodeRegex.test(postcode)) {
                showError('Please enter a valid UK postcode (e.g., SN1 1JJ)');
                return;
            }

            const btn = document.getElementById('postcodeBtn');
            btn.disabled = true;
            btn.textContent = 'Searching...';
            showLoading();
            
            console.log('[Frontend] Looking up postcode:', postcode);

            try {
                const url = `${API_BASE}/uprn-lookup`;
                console.log('[Frontend] Calling API:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ postcode })
                });

                console.log('[Frontend] Response status:', response.status);
                
                const data = await response.json();
                console.log('[Frontend] Response data:', data);

                if (!response.ok) {
                    showError(data.error || `Server error: ${response.status}`);
                    return;
                }

                if (data.error || !data.addresses || data.addresses.length === 0) {
                    showError(data.error || 'No addresses found for this postcode. Please check the postcode is in Swindon Borough.');
                    return;
                }

                addresses = data.addresses;
                
                // If only one address, auto-select and proceed
                if (addresses.length === 1) {
                    selectedUPRN = addresses[0].uprn;
                    await loadCollections(addresses[0].uprn);
                } else {
                    populateAddresses();
                    showSuccess(`Found ${addresses.length} addresses`);
                    updateSteps(2);
                }

            } catch (error) {
                console.error('[Frontend] Error:', error);
                showError(`Failed to lookup postcode: ${error.message}. Please check your connection and try again.`);
            } finally {
                hideLoading();
                btn.disabled = false;
                btn.textContent = 'Find Addresses';
            }
        }

        // Populate address list
        function populateAddresses() {
            const list = document.getElementById('addressList');
            const btn = document.getElementById('addressBtn');
            const searchInput = document.getElementById('addressSearch');
            
            // Clear previous content
            list.innerHTML = '';
            selectedUPRN = null;

            if (addresses.length === 0) {
                list.innerHTML = '<div class="no-addresses">No addresses found</div>';
                return;
            }

            // Render all addresses
            renderAddressList(addresses);

            // Reset button state
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Continue';
            }

            // Clear search input
            if (searchInput) {
                searchInput.value = '';
            }

            showElement('addressCard');
        }

        // Render address list items
        function renderAddressList(addressesToRender) {
            const list = document.getElementById('addressList');
            list.innerHTML = '';

            if (addressesToRender.length === 0) {
                list.innerHTML = '<div class="no-addresses">No matching addresses found</div>';
                return;
            }

            addressesToRender.forEach((addr) => {
                const item = document.createElement('div');
                item.className = 'address-item';
                item.dataset.uprn = addr.uprn;
                
                item.innerHTML = `
                    <div class="address-radio"></div>
                    <div class="address-text">${addr.address}</div>
                `;

                item.addEventListener('click', () => selectAddress(addr.uprn));
                list.appendChild(item);
            });
        }

        // Select an address
        function selectAddress(uprn) {
            selectedUPRN = uprn;
            const btn = document.getElementById('addressBtn');

            // Update UI - remove selected class from all items
            document.querySelectorAll('.address-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            const selectedItem = document.querySelector(`[data-uprn="${uprn}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            // Enable continue button
            if (btn) {
                btn.disabled = false;
            }
        }

        // Handle address selection
        async function handleAddressSelect() {
            if (!selectedUPRN) {
                showError('Please select an address');
                return;
            }

            const btn = document.getElementById('addressBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                await loadCollections(selectedUPRN);
            } catch (error) {
                console.error('[handleAddressSelect] Error:', error);
                btn.disabled = false;
                btn.textContent = 'Continue';
            }
        }

        // Load collections for a UPRN
        async function loadCollections(uprn) {
            selectedUPRN = uprn;
            showLoading();
            
            console.log('[Frontend] Fetching collections for UPRN:', uprn);

            try {
                const url = `${API_BASE}/waste-collections?uprn=${uprn}`;
                console.log('[Frontend] Calling API:', url);
                
                const response = await fetch(url);
                console.log('[Frontend] Response status:', response.status);
                
                // Get response text first to debug
                const responseText = await response.text();
                console.log('[Frontend] Raw response:', responseText);
                
                // Try to parse JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('[Frontend] JSON Parse Error:', parseError);
                    console.error('[Frontend] Response text:', responseText);
                    showError('Invalid response from server. Please try again.');
                    return;
                }
                console.log('[Frontend] Response data:', data);

                if (!response.ok) {
                    showError(data.error || `Server error: ${response.status}`);
                    return;
                }

                if (data.error) {
                    showError(data.error);
                    return;
                }

                if (!data.collections || data.collections.length === 0) {
                    showError('No collection data found for this address. Please contact Swindon Borough Council.');
                    return;
                }

                // Save to cache
                const selectedAddress = addresses.find(a => a.uprn === uprn);
                saveToCache(uprn, selectedAddress ? selectedAddress.address : '', data.collections);
                cachedCollections = data.collections;

                displayCollections(data.collections);
                updateSteps(3);
                
                // Schedule notifications if enabled
                if (Notification.permission === 'granted') {
                    scheduleNotifications();
                }

            } catch (error) {
                console.error('[Frontend] Error:', error);
                showError(`Failed to load collections: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Show collections from cache
        function showCollections() {
            if (cachedCollections) {
                displayCollections(cachedCollections);
                hideElement('postcodeCard');
                hideElement('addressCard');
                hideElement('step-indicator');
                updateSteps(3);
            }
        }

        // Calendar Functions - Add ALL collections
        function createICS(collection) {
            const title = `üóëÔ∏è ${collection.type}`;
            const description = `Tomorrow is your ${collection.type} collection day in Swindon. Don't forget to put your bins out!`;
            const location = 'Swindon, UK';

            const formatICSDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            // Create ICS content with all dates
            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Swindon Waste Collections//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

            // Add an event for each collection date
            const dates = collection.dates || [collection.date];
            dates.forEach((dateStr, index) => {
                const collectionDate = new Date(dateStr);
                const reminderDate = new Date(collectionDate);
                reminderDate.setDate(reminderDate.getDate() - 1);
                reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

                ics += `BEGIN:VEVENT
UID:${dateStr}-${collection.type.replace(/\s/g, '-')}-${index}@swindon-waste.app
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(reminderDate)}
DTEND:${formatICSDate(new Date(reminderDate.getTime() + 60*60*1000))}
SUMMARY:${title}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-PT0M
DESCRIPTION:${description}
ACTION:DISPLAY
END:VALARM
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        // Download ICS for ALL collection types
        function downloadAllICS() {
            if (!cachedCollections || cachedCollections.length === 0) {
                alert('No collections to add. Please select an address first.');
                return;
            }

            const formatICSDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Swindon Waste Collections//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

            let totalEvents = 0;
            
            // Add all collections and all their dates
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                const title = `üóëÔ∏è ${collection.type}`;
                const description = `Tomorrow is your ${collection.type} collection day in Swindon. Don't forget to put your bins out!`;
                
                dates.forEach((dateStr, index) => {
                    const collectionDate = new Date(dateStr);
                    const reminderDate = new Date(collectionDate);
                    reminderDate.setDate(reminderDate.getDate() - 1);
                    reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

                    ics += `BEGIN:VEVENT
UID:${dateStr}-${collection.type.replace(/\s/g, '-')}-${index}@swindon-waste.app
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(reminderDate)}
DTEND:${formatICSDate(new Date(reminderDate.getTime() + 60*60*1000))}
SUMMARY:${title}
DESCRIPTION:${description}
LOCATION:Swindon, UK
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-PT0M
DESCRIPTION:${description}
ACTION:DISPLAY
END:VALARM
END:VEVENT
`;
                    totalEvents++;
                });
            });

            ics += 'END:VCALENDAR';

            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `swindon-waste-collections.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess(`Calendar file with ${totalEvents} collection reminders downloaded! Open it to add to your calendar.`);
        }

        // Add ALL collections to Google Calendar
        function addAllToGoogleCalendar() {
            if (!cachedCollections || cachedCollections.length === 0) {
                alert('No collections to add. Please select an address first.');
                return;
            }

            let totalEvents = 0;
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                totalEvents += dates.length;
            });

            if (!confirm(`This will open ${totalEvents} Google Calendar tabs (one for each collection date). Continue?`)) {
                return;
            }

            let tabIndex = 0;
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                
                dates.forEach((dateStr) => {
                    setTimeout(() => {
                        const collectionDate = new Date(dateStr);
                        const reminderDate = new Date(collectionDate);
                        reminderDate.setDate(reminderDate.getDate() - 1);
                        reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

                        const formatGoogleDate = (date) => {
                            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        };

                        const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                        const details = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                        const location = encodeURIComponent('Swindon, UK');
                        const dateParam = `${formatGoogleDate(reminderDate)}/${formatGoogleDate(new Date(reminderDate.getTime() + 60*60*1000))}`;

                        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateParam}&details=${details}&location=${location}&reminder=0`;
                        window.open(url, '_blank');
                    }, tabIndex * 500); // Stagger opening tabs by 500ms
                    tabIndex++;
                });
            });
            
            showSuccess(`Opening ${totalEvents} Google Calendar tabs...`);
        }

        // Add ALL collections to Outlook Calendar
        function addAllToOutlookCalendar() {
            if (!cachedCollections || cachedCollections.length === 0) {
                alert('No collections to add. Please select an address first.');
                return;
            }

            let totalEvents = 0;
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                totalEvents += dates.length;
            });

            if (!confirm(`This will open ${totalEvents} Outlook Calendar tabs (one for each collection date). Continue?`)) {
                return;
            }

            let tabIndex = 0;
            cachedCollections.forEach(collection => {
                const dates = collection.dates || [collection.date];
                
                dates.forEach((dateStr) => {
                    setTimeout(() => {
                        const collectionDate = new Date(dateStr);
                        const reminderDate = new Date(collectionDate);
                        reminderDate.setDate(reminderDate.getDate() - 1);
                        reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

                        const formatOutlookDate = (date) => {
                            return date.toISOString();
                        };

                        const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                        const body = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                        const location = encodeURIComponent('Swindon, UK');
                        const startdt = formatOutlookDate(reminderDate);
                        const enddt = formatOutlookDate(new Date(reminderDate.getTime() + 60*60*1000));

                        const url = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&body=${body}&location=${location}&startdt=${startdt}&enddt=${enddt}&reminderMinutes=0`;
                        window.open(url, '_blank');
                    }, tabIndex * 500); // Stagger opening tabs by 500ms
                    tabIndex++;
                });
            });
            
            showSuccess(`Opening ${totalEvents} Outlook Calendar tabs...`);
        }

        // Legacy functions (kept for compatibility but not used in UI anymore)
        function downloadICS(collection) {
            const ics = createICS(collection);
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const numDates = collection.dates ? collection.dates.length : 1;
            link.download = `${collection.type.replace(/\s/g, '-')}-series.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess(`Calendar file with ${numDates} collection date(s) downloaded! Open it to add to your calendar.`);
        }

        function addToGoogleCalendar(collection) {
            // Google Calendar doesn't support multiple events in one URL,
            // so we'll open multiple tabs or use the first date with a note about the series
            const dates = collection.dates || [collection.date];
            
            if (dates.length === 1) {
                // Single event
                const collectionDate = new Date(dates[0]);
                const reminderDate = new Date(collectionDate);
                reminderDate.setDate(reminderDate.getDate() - 1);
                reminderDate.setHours(19, 0, 0, 0);

                const formatGoogleDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                const details = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                const location = encodeURIComponent('Swindon, UK');
                const dateParam = `${formatGoogleDate(reminderDate)}/${formatGoogleDate(new Date(reminderDate.getTime() + 60*60*1000))}`;

                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateParam}&details=${details}&location=${location}&reminder=0`;
                window.open(url, '_blank');
            } else {
                // Multiple events - open first one and show message
                if (confirm(`This will open ${dates.length} calendar events (one for each collection date). Continue?`)) {
                    dates.forEach((dateStr, index) => {
                        setTimeout(() => {
                            const collectionDate = new Date(dateStr);
                            const reminderDate = new Date(collectionDate);
                            reminderDate.setDate(reminderDate.getDate() - 1);
                            reminderDate.setHours(19, 0, 0, 0);

                            const formatGoogleDate = (date) => {
                                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                            };

                            const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                            const details = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                            const location = encodeURIComponent('Swindon, UK');
                            const dateParam = `${formatGoogleDate(reminderDate)}/${formatGoogleDate(new Date(reminderDate.getTime() + 60*60*1000))}`;

                            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateParam}&details=${details}&location=${location}&reminder=0`;
                            window.open(url, '_blank');
                        }, index * 500); // Stagger opening tabs by 500ms
                    });
                    showSuccess(`Opening ${dates.length} Google Calendar tabs...`);
                }
            }
        }

        function addToOutlookCalendar(collection) {
            // Outlook also doesn't support multiple events in one URL
            const dates = collection.dates || [collection.date];
            
            if (dates.length === 1) {
                // Single event
                const collectionDate = new Date(dates[0]);
                const reminderDate = new Date(collectionDate);
                reminderDate.setDate(reminderDate.getDate() - 1);
                reminderDate.setHours(19, 0, 0, 0);

                const formatOutlookDate = (date) => {
                    return date.toISOString();
                };

                const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                const body = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                const location = encodeURIComponent('Swindon, UK');
                const startdt = formatOutlookDate(reminderDate);
                const enddt = formatOutlookDate(new Date(reminderDate.getTime() + 60*60*1000));

                const url = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&body=${body}&location=${location}&startdt=${startdt}&enddt=${enddt}&reminderMinutes=0`;
                window.open(url, '_blank');
            } else {
                // Multiple events
                if (confirm(`This will open ${dates.length} Outlook calendar events (one for each collection date). Continue?`)) {
                    dates.forEach((dateStr, index) => {
                        setTimeout(() => {
                            const collectionDate = new Date(dateStr);
                            const reminderDate = new Date(collectionDate);
                            reminderDate.setDate(reminderDate.getDate() - 1);
                            reminderDate.setHours(19, 0, 0, 0);

                            const formatOutlookDate = (date) => {
                                return date.toISOString();
                            };

                            const title = encodeURIComponent(`üóëÔ∏è ${collection.type}`);
                            const body = encodeURIComponent(`Tomorrow is your ${collection.type} collection day. Don't forget to put your bins out!`);
                            const location = encodeURIComponent('Swindon, UK');
                            const startdt = formatOutlookDate(reminderDate);
                            const enddt = formatOutlookDate(new Date(reminderDate.getTime() + 60*60*1000));

                            const url = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&body=${body}&location=${location}&startdt=${startdt}&enddt=${enddt}&reminderMinutes=0`;
                            window.open(url, '_blank');
                        }, index * 500); // Stagger opening tabs by 500ms
                    });
                    showSuccess(`Opening ${dates.length} Outlook Calendar tabs...`);
                }
            }
        }

        // Display collections
        function displayCollections(collections) {
            const grid = document.getElementById('collectionsGrid');
            grid.innerHTML = '';

            // Sort by date
            collections.sort((a, b) => new Date(a.date) - new Date(b.date));

            collections.forEach(collection => {
                const card = document.createElement('div');
                card.className = `collection-card ${collection.color || ''}`;

                // Use actual bin image if available, otherwise use emoji
                let iconHtml;
                if (collection.bin_image) {
                    iconHtml = `<img src="${collection.bin_image}" alt="${collection.type}" style="width: 120px; height: 120px; object-fit: contain;">`;
                } else {
                    const icon = getWasteIcon(collection.type);
                    iconHtml = icon;
                }

                const daysText = getDaysText(collection.days_until);
                const dateText = formatDate(collection.date);

                // Display all future dates if available (skip first date as it's already shown)
                let futureDatesHtml = '';
                if (collection.dates && collection.dates.length > 1) {
                    futureDatesHtml = '<div class="future-dates"><strong>Future collections:</strong><ul>';
                    collection.dates.forEach((date, index) => {
                        if (index > 0) {  // Skip first date (already shown above)
                            futureDatesHtml += `<li>${formatDate(date)}</li>`;
                        }
                    });
                    futureDatesHtml += '</ul></div>';
                }

                card.innerHTML = `
                    <div class="collection-icon">${iconHtml}</div>
                    <div class="collection-type">${collection.type}</div>
                    <div class="collection-date">üìÖ ${dateText}</div>
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center; margin-top: 10px;">
                        <div class="collection-days ${getDaysClass(collection.days_until)}">
                            ${daysText}
                        </div>
                        <button class="add-calendar-btn" onclick='showCalendarOptions(${JSON.stringify(collection).replace(/'/g, "&#39;")})'>
                            + Add to Calendar
                        </button>
                    </div>
                    ${futureDatesHtml}
                `;

                grid.appendChild(card);
            });

            hideElement('postcodeCard');
            hideElement('addressCard');
            const stepIndicator = document.querySelector('.step-indicator');
            if (stepIndicator) stepIndicator.style.display = 'none';
            showElement('collectionsCard');
        }

        // Get waste icon (fallback emojis)
        function getWasteIcon(type) {
            const icons = {
                'Rubbish bin': 'üóëÔ∏è',
                'Rubbish bin and food waste': 'üóëÔ∏è',
                'Recycling boxes': '‚ôªÔ∏è',
                'Recycling and food waste': '‚ôªÔ∏è',
                'Garden waste bin': 'üçÇ',
                'Garden waste': 'üçÇ',
                'Plastics': 'üß¥'
            };
            return icons[type] || 'üì¶';
        }

        // Get days text
        function getDaysText(days) {
            if (days === 0) return 'Today!';
            if (days === 1) return 'Tomorrow';
            if (days < 0) return `${Math.abs(days)} days ago`;
            return `In ${days} days`;
        }

        // Get days class
        function getDaysClass(days) {
            if (days === 0) return 'today';
            if (days === 1) return 'tomorrow';
            return '';
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        // Reset form
        function reset() {
            document.getElementById('postcode').value = '';
            
            // Clear address list instead of select dropdown
            const addressList = document.getElementById('addressList');
            if (addressList) {
                addressList.innerHTML = '';
            }
            
            // Clear search input
            const addressSearch = document.getElementById('addressSearch');
            if (addressSearch) {
                addressSearch.value = '';
            }
            
            const addressBtn = document.getElementById('addressBtn');
            if (addressBtn) {
                addressBtn.disabled = true;
                addressBtn.textContent = 'Continue';
            }
            
            hideElement('addressCard');
            hideElement('collectionsCard');
            hideElement('cachedInfo');
            showElement('postcodeCard');
            
            // Show step indicator again
            const stepIndicator = document.querySelector('.step-indicator');
            if (stepIndicator) stepIndicator.style.display = 'flex';
            
            addresses = [];
            selectedUPRN = null;
            cachedCollections = null;
            updateSteps(1);
        }
            
            hideElement('addressCard');
            hideElement('collectionsCard');
            hideElement('cachedInfo');
            showElement('postcodeCard');
            
            addresses = [];
            selectedUPRN = null;
            cachedCollections = null;
            updateSteps(1);
        }

        // Handle Enter key on postcode input
        document.getElementById('postcode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                lookupPostcode();
            }
        });

        // Handle address search filtering
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('addressSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    
                    if (!searchTerm) {
                        renderAddressList(addresses);
                        return;
                    }

                    const filteredAddresses = addresses.filter(addr => 
                        addr.address.toLowerCase().includes(searchTerm)
                    );

                    renderAddressList(filteredAddresses);
                });
            }
        });

        // Calendar Modal Functions
        let selectedCollection = null;

        function showCalendarOptions(collection) {
            selectedCollection = collection;
            const modal = document.getElementById('calendarModal');
            modal.classList.add('active');
        }

        function closeCalendarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('calendarModal');
            modal.classList.remove('active');
            selectedCollection = null;
        }

        function selectCalendar(type) {
            if (!selectedCollection) return;

            if (type === 'google') {
                addSingleToGoogleCalendar(selectedCollection);
            } else if (type === 'apple' || type === 'outlook') {
                downloadSingleICS(selectedCollection, type);
            }

            closeCalendarModal();
        }

        // Add single collection date to Google Calendar
        function addSingleToGoogleCalendar(collection) {
            const collectionDate = new Date(collection.date);
            const reminderDate = new Date(collectionDate);
            reminderDate.setDate(reminderDate.getDate() - 1);
            reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

            const title = `üóëÔ∏è ${collection.type}`;
            const description = `Tomorrow is your ${collection.type} collection day in Swindon. Don't forget to put your bins out!`;
            const location = 'Swindon, UK';

            const formatGoogleDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const startDate = formatGoogleDate(reminderDate);
            const endDate = formatGoogleDate(new Date(reminderDate.getTime() + 60*60*1000));

            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;

            window.open(url, '_blank');
        }

        // Download ICS for single collection
        function downloadSingleICS(collection, type) {
            const collectionDate = new Date(collection.date);
            const reminderDate = new Date(collectionDate);
            reminderDate.setDate(reminderDate.getDate() - 1);
            reminderDate.setHours(17, 0, 0, 0); // 5 PM day before

            const title = `üóëÔ∏è ${collection.type}`;
            const description = `Tomorrow is your ${collection.type} collection day in Swindon. Don't forget to put your bins out!`;
            const location = 'Swindon, UK';

            const formatICSDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Swindon Waste Collections//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${collection.date}-${collection.type.replace(/\s/g, '-')}@swindon-waste.app
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(reminderDate)}
DTEND:${formatICSDate(new Date(reminderDate.getTime() + 60*60*1000))}
SUMMARY:${title}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-PT0M
DESCRIPTION:${description}
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${collection.type.replace(/\s/g, '-')}-${collection.date}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        updateSteps(1);
    </script>

    <!-- Calendar Selection Modal -->
    <div id="calendarModal" class="calendar-modal" onclick="closeCalendarModal(event)">
        <div class="calendar-modal-content" onclick="event.stopPropagation()">
            <h3>Add to Calendar</h3>
            <div class="calendar-options">
                <button class="calendar-option-btn" onclick="selectCalendar('google')">
                    <span class="icon">üìÖ</span>
                    <span>Google Calendar</span>
                </button>
                <button class="calendar-option-btn" onclick="selectCalendar('apple')">
                    <span class="icon">üçé</span>
                    <span>Apple Calendar</span>
                </button>
                <button class="calendar-option-btn" onclick="selectCalendar('outlook')">
                    <span class="icon">üìß</span>
                    <span>Outlook Calendar</span>
                </button>
            </div>
            <button class="modal-close" onclick="closeCalendarModal()">Cancel</button>
        </div>
    </div>
</body>
</html>

